{% extends 'adminapp/base.html' %}

{% block page_title %}Audit Logs{% endblock %}

{% block content %}
<div class="card" style="border: none; box-shadow: var(--shadow-md);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h2 style="font-weight: 800; color: var(--text-main); margin-bottom: 0.5rem;">System Activity Log</h2>
            <p style="color: var(--text-muted); font-size: 0.9rem;">Track all changes made to the system.</p>
        </div>
        <div style="display: flex; gap: 1rem;">
             <span class="badge badge-danger"> <i class="fa-solid fa-circle" style="font-size: 0.5rem; margin-right: 5px;"></i> Staff Action</span>
             <span class="badge badge-info"><i class="fa-solid fa-circle" style="font-size: 0.5rem; margin-right: 5px;"></i> Admin Action</span>
        </div>
    </div>

    <!-- Log Table -->
    <div class="data-table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>User</th>
                    <th>Action</th>
                    <th>Model</th>
                    <th>Object</th>
                    <th>Changes</th>
                    <th style="text-align: right;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr style="{% if not log.user.is_superuser %}background-color: #fef2f2;{% endif %}">
                    <td style="font-weight: 600; color: var(--text-muted); font-size: 0.85rem; white-space: nowrap;">
                        {{ log.timestamp|date:"M d, Y H:i" }}
                    </td>
                    <td>
                        {% if log.user %}
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 24px; height: 24px; border-radius: 50%; background: {% if log.user.is_superuser %}var(--primary){% else %}#ef4444{% endif %}; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 800;">
                                    {{ log.user.username|first|upper }}
                                </div>
                                <span style="font-weight: 700; color: var(--text-main);">{{ log.user.username }}</span>
                            </div>
                        {% else %}
                            <span class="badge badge-warning">System</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge 
                            {% if log.action == 'CREATE' %}badge-success
                            {% elif log.action == 'DELETE' %}badge-danger
                            {% else %}badge-info{% endif %}" style="font-size: 0.7rem;">
                            {{ log.action }}
                        </span>
                    </td>
                    <td style="font-weight: 600; font-size: 0.85rem;">{{ log.model_name }}</td>
                    <td style="font-size: 0.85rem; color: var(--text-muted);">{{ log.object_repr|truncatechars:30 }}</td>
                    <td style="font-size: 0.8rem;">
                        {% if log.changes %}
                           <span style="font-style: italic; color: var(--text-light);">Click 'View' to see details</span>
                        {% else %}
                            <span style="color: var(--text-light);">-</span>
                        {% endif %}
                    </td>
                    <td style="text-align: right;">
                        <div style="display: flex; justify-content: flex-end; gap: 8px;">
                            <button onclick="viewLogDetails({{ log.id }})" class="btn" style="background: var(--bg-body); padding: 6px 10px; color: var(--primary); font-size: 0.8rem;" title="View Details">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                            <a href="#" onclick="return confirmAction('{% url 'admin_audit_log_delete' log.id %}', 'Delete Entry?', 'See ko dhab ah ma u lalaabeysaa qoraalkan?')" class="btn" style="background: var(--bg-body); padding: 6px 10px; color: #ef4444; font-size: 0.8rem;" title="Delete Log">
                                <i class="fa-solid fa-trash-can"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                        <i class="fa-solid fa-clipboard-list" style="font-size: 2rem; margin-bottom: 1rem; color: var(--border-color);"></i>
                        <p>No activity recorded yet.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if logs.has_other_pages %}
    <div style="margin-top: 1.5rem; display: flex; justify-content: center; gap: 0.5rem;">
        {% if logs.has_previous %}
            <a href="?page={{ logs.previous_page_number }}" class="btn" style="background: white; border: 1px solid var(--border-color); color: var(--text-main); font-size: 0.8rem;"><i class="fa-solid fa-chevron-left"></i> Prev</a>
        {% endif %}
        
        <span style="display: flex; align-items: center; padding: 0 1rem; font-weight: 700; color: var(--text-muted); font-size: 0.85rem;">
            Page {{ logs.number }} of {{ logs.paginator.num_pages }}
        </span>

        {% if logs.has_next %}
            <a href="?page={{ logs.next_page_number }}" class="btn" style="background: white; border: 1px solid var(--border-color); color: var(--text-main); font-size: 0.8rem;">Next <i class="fa-solid fa-chevron-right"></i></a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
async function viewLogDetails(logId) {
    openModal('<i class="fa-solid fa-spinner fa-spin"></i> Loading...', '<div style="text-align: center; padding: 3rem;"><i class="fa-solid fa-circle-notch fa-spin" style="font-size: 2rem; color: var(--primary);"></i></div>');
    try {
        const res = await fetch(`/admin/api/audit-log/${logId}/`); 
        // Note: Check URL prefix if needed. adminapp URLs are under /admin/ if included there. 
        // Based on urls.py viewing, it seems included directly or under owner/. 
        // Let's check where adminapp.urls are included. 
        // Assuming /owner/ from previous context (backend implementation). Let's use relative path carefully or assume /owner/...
        
        const response = await fetch(`/owner/api/audit-log/${logId}/`);
        const data = await response.json();
        
        let changesHtml = '';
        if (data.changes) {
            for (const [field, diff] of Object.entries(data.changes)) {
                if (field !== 'updated_at' && field !== 'created_at') {
                    if (diff.old && diff.new) {
                        changesHtml += `
                        <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed var(--border-color);">
                            <b style="color: var(--text-light); text-transform: capitalize; display: block; margin-bottom: 4px;">${field}</b> 
                            <span style="text-decoration: line-through; color: #ef4444; background: #fef2f2; padding: 2px 6px; border-radius: 4px;">${diff.old}</span> 
                            <i class="fa-solid fa-arrow-right" style="font-size: 0.7rem; color: var(--text-light); margin: 0 6px;"></i> 
                            <span style="color: #16a34a; font-weight: 700; background: #f0fdf4; padding: 2px 6px; border-radius: 4px;">${diff.new}</span>
                        </div>`;
                    } else if (diff.info) {
                        changesHtml += `<div style="color: #ef4444; font-weight: 700;">${diff.info}</div>`;
                    } else {
                        changesHtml += `
                        <div style="margin-bottom: 4px;">
                            <b style="color: var(--text-light); text-transform: capitalize;">${field}:</b> 
                            <span style="color: var(--text-main);">${diff}</span>
                        </div>`;
                    }
                }
            }
        } else {
            changesHtml = '<span style="color: var(--text-light);">No changes recorded.</span>';
        }

        const html = `
            <div class="info-grid">
                <div class="info-item"><label>Executed By</label><span style="font-weight: 700; color: var(--primary);">${data.user}</span></div>
                <div class="info-item"><label>Role</label><span class="badge ${data.user_role === 'Super Admin' ? 'badge-primary' : 'badge-secondary'}">${data.user_role}</span></div>
                <div class="info-item"><label>Email</label><span>${data.user_email || 'N/A'}</span></div>
                <div class="info-item"><label>Action</label><span class="badge badge-info">${data.action}</span></div>
                <div class="info-item"><label>Timestamp</label><span>${data.timestamp}</span></div>
                <div class="info-item"><label>Model Type</label><span>${data.model}</span></div>
                <div class="info-item"><label>Object ID</label><span>#${data.object_id}</span></div>
                <div class="info-item" style="grid-column: span 2;"><label>Target Object</label><span>${data.object}</span></div>
            </div>
            
            <div style="background: var(--bg-body); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color); margin-top: 1rem;">
                <label style="display: block; font-size: 0.75rem; font-weight: 800; color: var(--text-light); text-transform: uppercase; margin-bottom: 1rem;">Changes Recorded</label>
                <div>${changesHtml}</div>
            </div>
        `;
        openModal('<i class="fa-solid fa-file-shield" style="color: var(--primary);"></i> Log Details', html);
    } catch (err) {
        console.error(err);
        openModal('Error', 'Failed to load details.');
    }
}
</script>
{% endblock %}
